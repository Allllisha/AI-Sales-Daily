name: Deploy Knowhow to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'knowhow/server/**'
      - 'knowhow/client/**'
      - 'knowhow/docker-compose.prod.yml'
      - 'knowhow/nginx.conf'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # --- Build & Test ---
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          knowhow/server/package-lock.json
          knowhow/client/package-lock.json

    - name: Install and lint server
      run: |
        cd knowhow/server
        npm ci
        npx eslint src/ --ext .js || true

    - name: Install, lint, and build client
      run: |
        cd knowhow/client
        npm ci
        npm run lint || true
        npm run build

  # --- Build & Push Docker Images ---
  build-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      uses: azure/docker-login@v2
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and push API image
      run: |
        docker build \
          -f knowhow/server/Dockerfile \
          --target production \
          -t ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-api:${{ github.sha }} \
          -t ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-api:latest \
          knowhow/
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-api:${{ github.sha }}
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-api:latest

    - name: Build and push Client image
      run: |
        docker build \
          -f knowhow/client/Dockerfile \
          --target production \
          --build-arg VITE_API_URL=${{ secrets.APP_SERVICE_API_URL }} \
          --build-arg VITE_WS_URL=${{ secrets.APP_SERVICE_WS_URL }} \
          -t ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-client:${{ github.sha }} \
          -t ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-client:latest \
          knowhow/client/
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-client:${{ github.sha }}
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-client:latest

  # --- Deploy API ---
  deploy-api:
    needs: build-docker
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy API to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME_API }}
        images: ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-api:${{ github.sha }}

    - name: Set startup command
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME_API }}
        startup-command: 'npm run db:startup && npm start'

  # --- Deploy Client ---
  deploy-client:
    needs: build-docker
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Client to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME_CLIENT }}
        images: ${{ secrets.ACR_LOGIN_SERVER }}/knowhow-client:${{ github.sha }}
