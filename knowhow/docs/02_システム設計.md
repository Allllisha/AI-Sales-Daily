# ノウハウ共有AI音声アシスタント - システム設計書

**作成日**: 2026-02-11
**ベース技術**: sales-app（営業日報アプリ）の技術スタックを最大限流用

---

## 1. システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント (PWA)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │事務作業   │  │現場作業   │  │ナレッジ   │  │分析      │   │
│  │モード     │  │モード     │  │管理       │  │ダッシュ  │   │
│  │(チャット) │  │(音声)     │  │(登録/検索)│  │ボード    │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │             │             │          │
│  ┌────┴─────────────┴─────────────┴─────────────┴────┐     │
│  │         Web Speech API / Azure Speech SDK          │     │
│  └────────────────────────┬──────────────────────────┘     │
│                           │                                 │
│  ┌────────────────────────┴──────────────────────────┐     │
│  │         IndexedDB (オフラインキャッシュ)             │     │
│  └───────────────────────────────────────────────────┘     │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTPS / WebSocket
┌───────────────────────────┴─────────────────────────────────┐
│                   Azure App Service                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Node.js + Express API Server              │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │
│  │  │認証      │ │ナレッジ  │ │AI対話    │ │分析     │ │  │
│  │  │ミドル    │ │API       │ │エンジン  │ │API      │ │  │
│  │  │ウェア    │ │          │ │          │ │         │ │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │
│  │  │音声処理  │ │検索      │ │ワーク    │             │  │
│  │  │サービス  │ │サービス  │ │フロー    │             │  │
│  │  │(STT/TTS)│ │(Vector)  │ │エンジン  │             │  │
│  │  └──────────┘ └──────────┘ └──────────┘             │  │
│  └───────────────────────────────────────────────────────┘  │
│                    Socket.IO (リアルタイム通信)               │
└──────┬────────────┬────────────┬────────────┬───────────────┘
       │            │            │            │
┌──────┴──┐  ┌──────┴──┐  ┌─────┴───┐  ┌────┴──────────────┐
│PostgreSQL│  │  Redis   │  │ Azure   │  │ Azure Cognitive   │
│Flexible  │  │  Cache   │  │ OpenAI  │  │ Search            │
│Server    │  │          │  │ (GPT-4) │  │ (ベクトル検索)     │
└──────────┘  └──────────┘  └─────────┘  └───────────────────┘
                                │
                         ┌──────┴──────┐
                         │ Azure Speech│
                         │ Services    │
                         │ (STT/TTS)   │
                         └─────────────┘
```

---

## 2. 技術スタック詳細

### 2.1 フロントエンド（sales-appベース）

| 技術 | バージョン | 用途 | 流用元 |
|------|-----------|------|--------|
| React | 18.x | UIフレームワーク | sales-app |
| Vite | 5.x | ビルドツール | sales-app |
| React Router DOM | 6.x | ルーティング | sales-app |
| TanStack React Query | 5.x | サーバーステート管理 | sales-app |
| Emotion | 11.x | CSS-in-JS | sales-app |
| Socket.IO Client | 4.x | リアルタイム通信 | sales-app |
| Workbox | 7.x | PWA/オフライン | sales-app |
| Recharts | 3.x | グラフ・分析表示 | sales-app |
| React Hook Form | 7.x | フォーム管理 | sales-app |
| React Hot Toast | 2.x | 通知 | sales-app |
| React Markdown | 10.x | ナレッジ表示 | sales-app |

### 2.2 バックエンド（sales-appベース）

| 技術 | バージョン | 用途 | 流用元 |
|------|-----------|------|--------|
| Node.js | 20.x | ランタイム | sales-app |
| Express | 4.x | APIフレームワーク | sales-app |
| Socket.IO | 4.x | WebSocket | sales-app |
| pg | 8.x | PostgreSQLドライバ | sales-app |
| ioredis | 5.x | Redisクライアント | sales-app |
| jsonwebtoken | 9.x | JWT認証 | sales-app |
| bcryptjs | 2.x | パスワードハッシュ | sales-app |
| helmet | 7.x | セキュリティヘッダ | sales-app |
| express-rate-limit | 7.x | レート制限 | sales-app |
| multer | 2.x | ファイルアップロード | sales-app |
| swagger-ui-express | 5.x | API仕様書 | sales-app |
| openai | 4.x | Azure OpenAI SDK | sales-app |
| Azure Speech SDK | 1.x | 音声認識/合成 | sales-app |

### 2.3 新規追加技術

| 技術 | 用途 |
|------|------|
| @azure/search-documents | Azure Cognitive Searchクライアント（ベクトル検索） |
| Azure OpenAI Embeddings (text-embedding-ada-002) | ナレッジのベクトル化 |
| pdf-parse / mammoth | ドキュメントからのナレッジ取り込み |
| Azure Notification Hubs SDK | プッシュ通知（将来対応） |

### 2.4 インフラ（sales-appベース）

| サービス | 用途 | 流用元 |
|---------|------|--------|
| Azure App Service | Webアプリホスティング | sales-app |
| Azure Container Registry | Dockerイメージ管理 | sales-app |
| Azure Database for PostgreSQL Flexible | データベース | sales-app |
| Azure Cache for Redis | キャッシュ | sales-app |
| Azure OpenAI Service | GPT-4, Embeddings | sales-app |
| Azure Speech Services | STT/TTS | sales-app |
| Azure Cognitive Search | ベクトル検索（**新規**） | - |
| Azure Blob Storage | ドキュメント・メディア保存 | sales-app |
| GitHub Actions | CI/CD | sales-app |

---

## 3. データベース設計

### 3.1 ER図（主要テーブル）

```
users
├── id (UUID, PK)
├── email (VARCHAR, UNIQUE)
├── password (VARCHAR, hashed)
├── name (VARCHAR)
├── role (ENUM: worker, expert, site_manager, admin)
├── department (VARCHAR)
├── site_id (FK → sites.id, NULLABLE)
├── manager_id (FK → users.id, NULLABLE)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

sites
├── id (UUID, PK)
├── name (VARCHAR)
├── location (VARCHAR)
├── description (TEXT)
├── status (ENUM: active, completed, suspended)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

knowledge_items
├── id (UUID, PK)
├── title (VARCHAR)
├── content (TEXT)
├── summary (TEXT, AI生成)
├── category (ENUM: procedure, safety, quality, cost, equipment, material)
├── work_type (VARCHAR)
├── risk_level (ENUM: low, medium, high, critical)
├── author_id (FK → users.id)
├── status (ENUM: draft, review, published, archived)
├── approved_by (FK → users.id, NULLABLE)
├── approved_at (TIMESTAMP, NULLABLE)
├── version (INTEGER)
├── parent_id (FK → knowledge_items.id, NULLABLE)
├── view_count (INTEGER, DEFAULT 0)
├── useful_count (INTEGER, DEFAULT 0)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

knowledge_tags
├── id (UUID, PK)
├── knowledge_id (FK → knowledge_items.id)
├── tag_name (VARCHAR)
└── auto_generated (BOOLEAN)

incident_cases
├── id (UUID, PK)
├── title (VARCHAR)
├── description (TEXT)
├── cause (TEXT)
├── countermeasure (TEXT)
├── site_id (FK → sites.id, NULLABLE)
├── work_type (VARCHAR)
├── severity (ENUM: minor, moderate, serious, critical)
├── occurred_at (DATE)
├── reported_by (FK → users.id)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

checklists
├── id (UUID, PK)
├── name (VARCHAR)
├── work_type (VARCHAR)
├── description (TEXT)
├── created_by (FK → users.id)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

checklist_items
├── id (UUID, PK)
├── checklist_id (FK → checklists.id)
├── content (TEXT)
├── priority (ENUM: required, recommended, optional)
├── related_knowledge_id (FK → knowledge_items.id, NULLABLE)
├── order_index (INTEGER)
└── created_at (TIMESTAMP)

voice_sessions
├── id (UUID, PK)
├── user_id (FK → users.id)
├── mode (ENUM: office, field)
├── site_id (FK → sites.id, NULLABLE)
├── work_type (VARCHAR, NULLABLE)
├── status (ENUM: active, completed, cancelled)
├── created_at (TIMESTAMP)
└── completed_at (TIMESTAMP, NULLABLE)

voice_session_messages
├── id (UUID, PK)
├── session_id (FK → voice_sessions.id)
├── role (ENUM: user, assistant)
├── content (TEXT)
├── audio_url (VARCHAR, NULLABLE)
├── confidence (FLOAT, NULLABLE)
├── related_knowledge_ids (TEXT[], ナレッジ参照)
├── order_index (INTEGER)
└── created_at (TIMESTAMP)

usage_logs
├── id (UUID, PK)
├── user_id (FK → users.id)
├── knowledge_id (FK → knowledge_items.id, NULLABLE)
├── action_type (ENUM: view, search, voice_query, useful_mark, checklist_use)
├── context_site_id (FK → sites.id, NULLABLE)
├── context_work_type (VARCHAR, NULLABLE)
├── search_query (TEXT, NULLABLE)
└── created_at (TIMESTAMP)
```

### 3.2 Azure Cognitive Search インデックス

```json
{
  "name": "knowledge-index",
  "fields": [
    { "name": "id", "type": "Edm.String", "key": true },
    { "name": "title", "type": "Edm.String", "searchable": true },
    { "name": "content", "type": "Edm.String", "searchable": true },
    { "name": "category", "type": "Edm.String", "filterable": true },
    { "name": "work_type", "type": "Edm.String", "filterable": true },
    { "name": "risk_level", "type": "Edm.String", "filterable": true },
    { "name": "contentVector", "type": "Collection(Edm.Single)", "dimensions": 1536, "vectorSearchProfile": "default" }
  ],
  "vectorSearch": {
    "algorithms": [{ "name": "hnsw", "kind": "hnsw" }],
    "profiles": [{ "name": "default", "algorithm": "hnsw" }]
  }
}
```

---

## 4. API設計

### 4.1 認証API（sales-appベース流用）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/auth/register | ユーザー登録 |
| POST | /api/auth/login | ログイン（JWT発行） |
| POST | /api/auth/logout | ログアウト |
| POST | /api/auth/refresh | トークンリフレッシュ |
| GET | /api/auth/me | 自分の情報取得 |

### 4.2 ナレッジAPI（新規）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/knowledge | ナレッジ一覧取得（フィルタ対応） |
| GET | /api/knowledge/:id | ナレッジ詳細取得 |
| POST | /api/knowledge | ナレッジ新規登録 |
| PUT | /api/knowledge/:id | ナレッジ更新 |
| DELETE | /api/knowledge/:id | ナレッジ削除 |
| POST | /api/knowledge/:id/approve | ナレッジ承認 |
| POST | /api/knowledge/search | セマンティック検索（ベクトル検索） |
| GET | /api/knowledge/:id/related | 関連ナレッジ取得 |
| POST | /api/knowledge/:id/useful | 「役に立った」マーク |

### 4.3 事例API（新規）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/incidents | 事例一覧取得 |
| GET | /api/incidents/:id | 事例詳細取得 |
| POST | /api/incidents | 事例登録 |
| PUT | /api/incidents/:id | 事例更新 |
| POST | /api/incidents/search | 類似事例検索 |

### 4.4 チェックリストAPI（新規）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/checklists | チェックリスト一覧 |
| GET | /api/checklists/:id | チェックリスト詳細 |
| POST | /api/checklists | チェックリスト作成 |
| POST | /api/checklists/:id/execute | チェックリスト実行開始 |

### 4.5 AI対話API（sales-appベース拡張）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/ai/chat | AIチャット（事務作業モード） |
| POST | /api/ai/voice-session | 音声セッション開始（現場作業モード） |
| POST | /api/ai/risk-assessment | リスク評価リクエスト |
| POST | /api/ai/summarize | ナレッジ要約生成 |
| POST | /api/ai/extract-tags | 自動タグ抽出 |

### 4.6 音声API（sales-appベース流用）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/speech/token | Azure Speech Tokenの取得 |
| WebSocket | /realtime | リアルタイム音声ストリーミング |

### 4.7 分析API（sales-appベース拡張）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/analytics/usage | ナレッジ活用状況 |
| GET | /api/analytics/users/:id | ユーザー別学習進捗 |
| GET | /api/analytics/risks | リスク傾向分析 |
| GET | /api/analytics/knowledge-gaps | ナレッジギャップ分析 |

### 4.8 管理API（新規）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/sites | 現場一覧 |
| POST | /api/sites | 現場登録 |
| PUT | /api/sites/:id | 現場更新 |
| GET | /api/users | ユーザー一覧（管理者用） |
| PUT | /api/users/:id/role | 権限変更 |

---

## 5. AI対話フロー設計

### 5.1 事務作業モード（チャットボットフロー）

```
[ユーザー] → 施工検討開始
    │
    ▼
[AI] → 「これから施工検討を始めます。工種を教えてください。」
    │
    ▼
[ユーザー] → 「杭打ち工事です」
    │
    ▼
[AI] → (work_type=杭打ち でナレッジ検索)
    │  → (過去の類災事例を検索)
    │  → (チェックリスト取得)
    │
    ▼
[AI] → 「杭打ち工事ですね。まず確認です。地盤調査結果は確認されていますか？
        過去に○○現場で地盤条件の確認不足によるトラブルがありました。」
    │
    ▼
    ... (チェックリストに沿って対話を継続)
    │
    ▼
[AI] → 「全項目確認完了しました。リスク評価結果：
        ・高リスク: 地下水位の変動（要注意）
        ・中リスク: 近隣への振動影響
        以下のナレッジが参考になります...」
```

### 5.2 現場作業モード（音声フロー）

```
[ユーザー] → マイクボタンタップ
    │
    ▼
[AI] → 「お疲れ様です。現場の状況を教えてください。」（音声）
    │
    ▼
[ユーザー] → 「今から橋梁の補修作業を始めます」（音声入力）
    │
    ▼
[AI] → (Azure Speech STT でテキスト化)
    │  → (work_type=橋梁補修 でナレッジ検索)
    │  → (類似事例検索)
    │
    ▼
[AI] → 「橋梁補修作業ですね。開始前に確認です。
        足場の点検は完了していますか？
        先月○○橋で類似作業中に足場不具合がありました。
        ご注意ください。」（音声出力）
    │
    ▼
    ... (作業中のプッシュ型アドバイス)
```

### 5.3 プロンプト設計（Azure OpenAI）

```
System Prompt（事務作業モード）:
あなたは建設・土木現場のベテラン技術者AIアシスタントです。
施工検討・事前準備をサポートします。
以下のルールに従ってください：
1. チェックリストに沿って一つずつ確認する
2. 関連する過去の事故・トラブル事例があれば必ず提示する
3. リスク評価を行い、注意すべき点を明確に伝える
4. 専門用語は正確に使うが、わかりやすく説明する
5. 不明な点があれば確認の質問をする

参照ナレッジ:
{検索結果から取得したナレッジ}

参照事例:
{類似事例の検索結果}
```

---

## 6. 音声処理アーキテクチャ

### 6.1 音声フロー（sales-appのリアルタイム音声機能をベース）

```
[マイク] → Web Speech API（ブラウザ内、短時間向け）
        → Azure Speech SDK（WebSocket経由、長時間・高精度向け）
              │
              ▼
         [テキスト化]
              │
              ▼
    [Azure OpenAI GPT-4]
    + [Azure Cognitive Search]（関連ナレッジ検索）
              │
              ▼
         [AI応答テキスト]
              │
              ▼
    [Azure Speech TTS] → Nanami Neural Voice (ja-JP)
              │
              ▼
         [スピーカー出力]
```

### 6.2 騒音対策

- Azure Speech SDKのノイズ抑制機能を活用
- 信頼度スコアが低い場合は再入力を促す（sales-appの信頼度チェック機能を流用）
- テキスト入力へのフォールバック提案

---

## 7. セキュリティ設計

| 対策 | 実装 | 流用元 |
|------|------|--------|
| 通信暗号化 | HTTPS（Azure App Service SSL） | sales-app |
| 認証 | JWT（24h有効期限 + 7日リフレッシュ） | sales-app |
| パスワード | bcryptjs によるハッシュ化 | sales-app |
| HTTPヘッダ | helmet によるセキュリティヘッダ設定 | sales-app |
| レート制限 | express-rate-limit（1000req/15min） | sales-app |
| 入力検証 | express-validator | sales-app |
| CORS | 許可オリジンのホワイトリスト | sales-app |
| 機密情報 | 環境変数管理（.env, Azure App Settings） | sales-app |
| データ暗号化 | PostgreSQL TDE + Azure暗号化 | sales-app |

---

## 8. デプロイ構成

### 8.1 Docker構成（sales-appベース）

```yaml
# docker-compose.yml
services:
  api:
    build: ./server
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://redis:6379
      - AZURE_OPENAI_ENDPOINT=...
      - AZURE_SPEECH_KEY=...
      - AZURE_SEARCH_ENDPOINT=...  # 新規
      - AZURE_SEARCH_KEY=...       # 新規
    depends_on:
      - postgres
      - redis

  client:
    build: ./client
    ports:
      - "5173:80"

  postgres:
    image: postgres:14-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
```

### 8.2 Azure本番構成

```
Azure Container Registry
  └─ knowhow-api:latest
  └─ knowhow-client:latest

Azure App Service (API)
  └─ knowhow-api.azurewebsites.net

Azure App Service (Client)
  └─ knowhow-app.azurewebsites.net

Azure Database for PostgreSQL Flexible Server
  └─ knowhow-db

Azure Cache for Redis
  └─ knowhow-cache

Azure Cognitive Search
  └─ knowhow-search（新規）

Azure OpenAI Service
  └─ GPT-4 deployment
  └─ text-embedding-ada-002 deployment（新規）

Azure Speech Services
  └─ ja-JP STT/TTS
```
