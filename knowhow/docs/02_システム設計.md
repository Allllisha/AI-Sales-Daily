# ノウハウ共有AI音声アシスタント - システム設計書

**作成日**: 2026-02-11
**最終更新**: 2026-02-12
**ステータス**: 本番稼働中

---

## 1. システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント (PWA)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │事務作業   │  │現場作業   │  │ナレッジ   │  │分析      │   │
│  │モード     │  │モード     │  │管理       │  │ダッシュ  │   │
│  │(チャット) │  │(音声)     │  │(登録/検索)│  │ボード    │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │             │             │          │
│  ┌────┴─────────────┴─────────────┴─────────────┴────┐     │
│  │   Web Speech API / Azure Speech SDK (STT)         │     │
│  │   Web Audio API / Azure TTS (音声出力)             │     │
│  └────────────────────────┬──────────────────────────┘     │
│                           │                                 │
│  ┌────────────────────────┴──────────────────────────┐     │
│  │   IndexedDB (オフラインキャッシュ / 下書き保存)      │     │
│  │   Workbox Service Worker (PWA / キャッシュ戦略)     │     │
│  └───────────────────────────────────────────────────┘     │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTPS / WebSocket (Socket.IO)
┌───────────────────────────┴─────────────────────────────────┐
│              Azure App Service (knowhow-api)                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Node.js + Express API Server              │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │
│  │  │認証      │ │ナレッジ  │ │AI対話    │ │分析     │ │  │
│  │  │ミドル    │ │API       │ │エンジン  │ │API      │ │  │
│  │  │ウェア    │ │(CRUD)    │ │(Chat/TTS)│ │         │ │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │
│  │  │音声処理  │ │ベクトル  │ │事例      │ │チェック │ │  │
│  │  │サービス  │ │検索      │ │管理API   │ │リストAPI│ │  │
│  │  │(STT/TTS)│ │サービス  │ │          │ │         │ │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  React SPA (client/dist) - 静的ファイル配信             │  │
│  └───────────────────────────────────────────────────────┘  │
│                    Socket.IO (リアルタイム音声通信)           │
└──────┬────────────┬────────────┬────────────┬───────────────┘
       │            │            │            │
┌──────┴──┐  ┌──────┴──┐  ┌─────┴───┐  ┌────┴──────────────┐
│PostgreSQL│  │  Redis   │  │ Azure   │  │ Azure Cognitive   │
│Flexible  │  │  Cache   │  │ OpenAI  │  │ Search            │
│Server    │  │          │  │(GPT-4o  │  │(ベクトル検索)      │
│          │  │          │  │ -mini)  │  │                   │
└──────────┘  └──────────┘  └────┬────┘  └───────────────────┘
                                 │
                          ┌──────┴──────┐
                          │ Azure Speech│
                          │ Services    │
                          │ (STT/TTS)   │
                          │ japaneast   │
                          └─────────────┘
```

### 1.1 デプロイ構成

本番環境では**単一コンテナ構成**を採用。APIサーバーがReactビルド成果物も配信する。

```
knowhow-api (Azure App Service)
├── Node.js Express Server (port 3001)
├── React SPA (client/dist) ← Docker内で組み込み
├── Socket.IO WebSocket
└── Health Check (/ping, /health)
```

---

## 2. 技術スタック詳細

### 2.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| React | 18.x | UIフレームワーク |
| Vite | 5.4.x | ビルドツール |
| React Router DOM | 6.20.x | ルーティング（25画面） |
| TanStack React Query | 5.13.x | サーバーステート管理 |
| Emotion | 11.x | CSS-in-JS スタイリング |
| React Hook Form | 7.48.x | フォーム管理 |
| Axios | 1.6.x | HTTPクライアント（JWTインターセプター付き） |
| Socket.IO Client | 4.8.x | WebSocketリアルタイム通信 |
| Recharts | 3.1.x | グラフ・分析表示 |
| React Icons | 5.5.x | アイコンライブラリ |
| React Markdown | 10.1.x | ナレッジのMarkdown表示 |
| React Hot Toast | 2.4.x | トースト通知 |
| Workbox Window | 7.0.x | Service Worker管理 |
| Vite PWA Plugin | 0.17.x | PWA設定・自動生成 |

### 2.2 バックエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Node.js | 20.x (Alpine) | ランタイム |
| Express | 4.18.x | APIフレームワーク |
| Socket.IO | 4.8.x | WebSocket（リアルタイム音声） |
| pg | 8.11.x | PostgreSQLドライバ |
| ioredis | 5.7.x | Redisクライアント（フォールバック対応） |
| jsonwebtoken | 9.0.x | JWT認証 |
| bcryptjs | 2.4.x | パスワードハッシュ |
| helmet | 7.1.x | セキュリティヘッダ（カスタムCSP） |
| cors | 2.8.x | CORS制御 |
| express-rate-limit | 7.1.x | レート制限 |
| express-validator | 7.0.x | 入力バリデーション |
| openai | 4.20.x | Azure OpenAI SDK |
| microsoft-cognitiveservices-speech-sdk | 1.45.x | Azure Speech STT/TTS |
| @azure/search-documents | 12.1.x | Azure Cognitive Search |
| multer | 2.0.x | ファイルアップロード |
| swagger-jsdoc | 6.2.x | API仕様自動生成 |
| swagger-ui-express | 5.0.x | Swagger UI |

### 2.3 インフラ（Azure）

| サービス | リソース名 | 用途 |
|---------|-----------|------|
| Azure App Service | knowhow-api | APIサーバー + クライアント配信 |
| Azure Container Registry | knowhowacr | Dockerイメージ管理 |
| Azure Database for PostgreSQL Flexible | knowhow-db | データベース |
| Azure Cache for Redis | knowhow-cache | キャッシュ（TLS接続、port 6380） |
| Azure OpenAI Service | eastus | GPT-4o-mini, text-embedding-ada-002 |
| Azure Speech Services | japaneast | STT/TTS (Nanami Neural Voice) |
| Azure Cognitive Search | knowhow-search | ベクトル検索 (knowledge-index) |
| GitHub Actions | - | CI/CD パイプライン |

---

## 3. データベース設計

### 3.1 テーブル一覧（12テーブル）

```sql
-- ユーザー管理
users
├── id (SERIAL, PK)
├── email (VARCHAR, UNIQUE, NOT NULL)
├── password (VARCHAR, NOT NULL, bcryptハッシュ)
├── name (VARCHAR, NOT NULL)
├── role (VARCHAR: worker/expert/site_manager/admin)
├── department (VARCHAR)
├── site_id (FK → sites.id, NULLABLE)
├── manager_id (FK → users.id, NULLABLE)
├── created_at (TIMESTAMP, DEFAULT NOW())
└── updated_at (TIMESTAMP, DEFAULT NOW())

-- 現場管理
sites
├── id (SERIAL, PK)
├── name (VARCHAR, NOT NULL)
├── location (VARCHAR)
├── description (TEXT)
├── status (VARCHAR: active/completed/suspended, DEFAULT 'active')
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

-- ナレッジ
knowledge_items
├── id (SERIAL, PK)
├── title (VARCHAR, NOT NULL)
├── content (TEXT, NOT NULL)
├── summary (TEXT) -- AI生成
├── category (VARCHAR: procedure/safety/quality/cost/equipment/material)
├── work_type (VARCHAR)
├── risk_level (VARCHAR: low/medium/high/critical)
├── author_id (FK → users.id)
├── status (VARCHAR: draft/review/published/archived, DEFAULT 'draft')
├── approved_by (FK → users.id, NULLABLE)
├── approved_at (TIMESTAMP, NULLABLE)
├── version (INTEGER, DEFAULT 1)
├── parent_id (FK → knowledge_items.id, NULLABLE)
├── view_count (INTEGER, DEFAULT 0)
├── useful_count (INTEGER, DEFAULT 0)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

-- ナレッジタグ
knowledge_tags
├── id (SERIAL, PK)
├── knowledge_id (FK → knowledge_items.id, ON DELETE CASCADE)
├── tag_name (VARCHAR, NOT NULL)
└── auto_generated (BOOLEAN, DEFAULT false)

-- 類災事例
incident_cases
├── id (SERIAL, PK)
├── title (VARCHAR, NOT NULL)
├── description (TEXT)
├── cause (TEXT)
├── countermeasure (TEXT)
├── site_id (FK → sites.id, NULLABLE)
├── work_type (VARCHAR)
├── severity (VARCHAR: minor/moderate/serious/critical)
├── occurred_at (DATE)
├── reported_by (FK → users.id)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

-- チェックリスト
checklists
├── id (SERIAL, PK)
├── name (VARCHAR, NOT NULL)
├── work_type (VARCHAR)
├── description (TEXT)
├── created_by (FK → users.id)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

-- チェックリスト項目
checklist_items
├── id (SERIAL, PK)
├── checklist_id (FK → checklists.id, ON DELETE CASCADE)
├── content (TEXT, NOT NULL)
├── priority (VARCHAR: required/recommended/optional, DEFAULT 'required')
├── related_knowledge_id (FK → knowledge_items.id, NULLABLE)
├── order_index (INTEGER, DEFAULT 0)
└── created_at (TIMESTAMP)

-- チェックリスト実行
checklist_executions
├── id (SERIAL, PK)
├── checklist_id (FK → checklists.id)
├── user_id (FK → users.id)
├── site_id (FK → sites.id, NULLABLE)
├── total_items (INTEGER)
├── checked_items (INTEGER, DEFAULT 0)
├── status (VARCHAR: in_progress/completed, DEFAULT 'in_progress')
├── notes (TEXT)
├── completed_at (TIMESTAMP, NULLABLE)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)

-- チェックリスト実行項目
checklist_execution_items
├── id (SERIAL, PK)
├── execution_id (FK → checklist_executions.id, ON DELETE CASCADE)
├── checklist_item_id (FK → checklist_items.id)
├── item_content (TEXT)
├── is_required (BOOLEAN, DEFAULT true)
├── checked (BOOLEAN, DEFAULT false)
└── note (TEXT)

-- 音声セッション
voice_sessions
├── id (SERIAL, PK)
├── user_id (FK → users.id)
├── mode (VARCHAR: office/field)
├── site_id (FK → sites.id, NULLABLE)
├── work_type (VARCHAR, NULLABLE)
├── title (VARCHAR)
├── status (VARCHAR: active/completed/cancelled, DEFAULT 'active')
├── created_at (TIMESTAMP)
└── completed_at (TIMESTAMP, NULLABLE)

-- 音声セッションメッセージ
voice_session_messages
├── id (SERIAL, PK)
├── session_id (FK → voice_sessions.id, ON DELETE CASCADE)
├── role (VARCHAR: user/assistant)
├── content (TEXT)
├── audio_url (VARCHAR, NULLABLE)
├── confidence (FLOAT, NULLABLE)
├── related_knowledge_ids (TEXT[])
├── order_index (INTEGER)
└── created_at (TIMESTAMP)

-- 利用ログ
usage_logs
├── id (SERIAL, PK)
├── user_id (FK → users.id)
├── knowledge_id (FK → knowledge_items.id, NULLABLE)
├── action_type (VARCHAR: view/search/voice_query/useful_mark/checklist_use)
├── context_site_id (FK → sites.id, NULLABLE)
├── context_work_type (VARCHAR, NULLABLE)
├── search_query (TEXT, NULLABLE)
└── created_at (TIMESTAMP, DEFAULT NOW())
```

### 3.2 主要インデックス

```sql
-- ユーザー検索
idx_users_email, idx_users_role, idx_users_site_id, idx_users_manager_id

-- ナレッジ検索・フィルタ
idx_knowledge_category, idx_knowledge_work_type, idx_knowledge_status
idx_knowledge_author, idx_knowledge_risk_level

-- タグ検索
idx_knowledge_tags_knowledge_id, idx_knowledge_tags_tag_name

-- 事例検索
idx_incidents_severity, idx_incidents_site_id, idx_incidents_work_type

-- セッション・メッセージ
idx_voice_sessions_user_id, idx_voice_session_messages_session_id

-- 利用ログ分析
idx_usage_logs_user_id, idx_usage_logs_knowledge_id
idx_usage_logs_action_type, idx_usage_logs_created_at
```

### 3.3 Azure Cognitive Search インデックス

```json
{
  "name": "knowledge-index",
  "fields": [
    { "name": "id", "type": "Edm.String", "key": true },
    { "name": "title", "type": "Edm.String", "searchable": true },
    { "name": "content", "type": "Edm.String", "searchable": true },
    { "name": "category", "type": "Edm.String", "filterable": true },
    { "name": "work_type", "type": "Edm.String", "filterable": true },
    { "name": "risk_level", "type": "Edm.String", "filterable": true },
    { "name": "contentVector", "type": "Collection(Edm.Single)", "dimensions": 1536, "vectorSearchProfile": "default" }
  ],
  "vectorSearch": {
    "algorithms": [{ "name": "hnsw", "kind": "hnsw" }],
    "profiles": [{ "name": "default", "algorithm": "hnsw" }]
  }
}
```

---

## 4. API設計

### 4.1 認証API (`/api/auth`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| POST | /register | ユーザー登録（ロール・部署・現場選択） | 不要 |
| POST | /login | ログイン（JWT発行） | 不要 |
| GET | /me | 自分の情報取得 | 必要 |
| POST | /refresh | トークンリフレッシュ | 必要 |
| POST | /logout | ログアウト | 必要 |
| POST | /reset-password | パスワードリセット | 不要 |

### 4.2 ナレッジAPI (`/api/knowledge`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | / | ナレッジ一覧取得（カテゴリ・工種・状態フィルタ） | 必要 |
| POST | / | ナレッジ新規登録 | expert以上 |
| GET | /:id | ナレッジ詳細取得（閲覧数カウント） | 必要 |
| PUT | /:id | ナレッジ更新 | 作成者 or manager以上 |
| DELETE | /:id | ナレッジ削除 | 作成者 or admin |
| POST | /:id/approve | ナレッジ承認（review→published） | manager以上 |
| POST | /search | セマンティック検索（ベクトル検索） | 必要 |
| GET | /:id/related | 関連ナレッジ取得 | 必要 |
| POST | /:id/useful | 「役に立った」マーク | 必要 |
| GET | /export/csv | CSVエクスポート | manager以上 |

### 4.3 事例API (`/api/incidents`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | / | 事例一覧取得（重大度・工種フィルタ） | 必要 |
| POST | / | 事例登録 | expert以上 |
| GET | /:id | 事例詳細取得 | 必要 |
| PUT | /:id | 事例更新 | 作成者 or manager以上 |
| POST | /search | 類似事例検索 | 必要 |

### 4.4 チェックリストAPI (`/api/checklists`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | / | チェックリスト一覧 | 必要 |
| POST | / | チェックリスト作成 | expert以上 |
| GET | /:id | チェックリスト詳細（項目含む） | 必要 |
| PUT | /:id | チェックリスト更新 | 作成者 or manager以上 |
| POST | /:id/execute | チェックリスト実行開始 | 必要 |
| GET | /:id/executions | 実行履歴一覧 | 必要 |
| GET | /executions/:executionId | 実行詳細 | 必要 |

### 4.5 AI対話API (`/api/ai`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| POST | /chat | AIチャット（事務作業モード） | 必要 |
| POST | /voice-session | 音声セッション開始 | 必要 |
| GET | /voice-sessions | セッション一覧取得 | 必要 |
| GET | /voice-sessions/:id | セッション詳細取得 | 必要 |
| PUT | /voice-sessions/:id/complete | セッション完了 | 必要 |
| POST | /voice-sessions/:id/messages | メッセージ追加 | 必要 |
| DELETE | /voice-sessions/:id | セッション削除 | 必要 |
| POST | /risk-assessment | リスク評価リクエスト | 必要 |
| POST | /summarize | ナレッジ要約生成 | 必要 |
| POST | /extract-tags | 自動タグ抽出 | 必要 |
| POST | /correct-speech | 音声認識テキスト補正 | 必要 |
| POST | /analyze-conversation | 会話分析 | 必要 |

### 4.6 音声API (`/api/speech`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | /token | Azure Speech Tokenの取得 | 必要 |
| POST | /synthesize | テキスト→音声合成（Azure TTS） | 必要 |

### 4.7 分析API (`/api/analytics`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | /usage | ナレッジ活用状況 | manager以上 |
| GET | /users/:id | ユーザー別学習進捗 | 本人 or manager以上 |
| GET | /risks | リスク傾向分析 | 必要 |
| GET | /knowledge-gaps | ナレッジギャップ分析 | manager以上 |
| GET | /export/csv | 分析CSVエクスポート | manager以上 |
| GET | /export/pdf | 分析PDFエクスポート | manager以上 |

### 4.8 管理API

#### 現場管理 (`/api/sites`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | / | 現場一覧 | 必要 |
| POST | / | 現場登録 | manager以上 |
| GET | /:id | 現場詳細 | 必要 |
| PUT | /:id | 現場更新 | manager以上 |

#### ユーザー管理 (`/api/users`)

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | /me | 自分のプロフィール | 必要 |
| GET | /team | チームメンバー一覧 | manager以上 |
| GET | /managers | マネージャー一覧 | 必要 |
| GET | / | 全ユーザー一覧 | admin |
| PUT | /:id | ユーザー情報更新 | admin |
| PUT | /:id/role | 権限変更 | admin |

### 4.9 ヘルスチェック

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /health | フルヘルスチェック（DB, Redis, 環境情報） |
| GET | /ping | ライブネスプローブ（"pong"を返す） |

### 4.10 WebSocket（Socket.IO）

| イベント | 方向 | 説明 |
|---------|------|------|
| connection | Client → Server | 認証付きWebSocket接続開始 |
| realtime-voice | 双方向 | リアルタイム音声ストリーミング |

認証: `socket.handshake.auth.token` でJWTトークンを検証

---

## 5. AI対話フロー設計

### 5.1 事務作業モード（OfficeChatPage）

```
[ユーザー] → チャット画面を開く
    │
    ▼
[システム] → 新規セッション作成（POST /api/ai/voice-session）
    │        ← サイドバーに会話履歴一覧を表示
    │
    ▼
[ユーザー] → テキストで質問を入力
    │
    ▼
[AI対話サービス]
    ├─ Azure OpenAI GPT-4o-mini で応答生成
    ├─ 建設・土木向けSystem Promptを使用
    ├─ 過去の会話履歴をコンテキストに含む
    └─ 関連ナレッジ・事例をDB検索して参照
    │
    ▼
[レスポンス] → AI応答 + 参照したナレッジリンク
    │
    ▼
[保存] → voice_session_messages にメッセージ保存
```

### 5.2 現場作業モード（FieldVoicePage）

```
[ユーザー] → マイクボタンタップ
    │
    ▼
[Web Speech API] → 音声認識（ja-JP）
    │               30秒タイムアウト
    │
    ▼
[テキスト化] → 認識結果を画面に表示
    │
    ▼
[API呼び出し] → POST /api/ai/chat
    │            ← 建設現場向けSystem Prompt
    │            ← ナレッジDB・事例DBから関連情報を検索して注入
    │
    ▼
[AI応答テキスト] → 画面に表示
    │
    ▼
[TTS] → POST /api/speech/synthesize
    │    ← Azure Speech TTS (Nanami Neural Voice, ja-JP)
    │    ← SSML形式で音声合成
    │
    ▼
[Web Audio API] → AudioContext.decodeAudioData() で再生
    │              ※ blob: URL不使用（CSP対策）
    │
    ▼
[VADエコーキャンセル] → TTS再生中は音声認識を抑制
    │
    ▼
[関連ナレッジ] → サイドパネルに関連ナレッジカードを表示
```

### 5.3 音声再生の技術詳細

```
Azure TTS API → MP3バイナリ (ArrayBuffer)
    │
    ▼
Web Audio API
    ├─ new AudioContext()
    ├─ decodeAudioData(arrayBuffer)
    ├─ createBufferSource()
    ├─ connect(destination)
    └─ start()
    │
    ▼
フォールバック: ブラウザ内蔵TTS (SpeechSynthesis API)
```

### 5.4 Azure OpenAI プロンプト設計

```
System Prompt（事務作業モード）:
あなたは建設・土木現場のベテラン技術者AIアシスタントです。
施工検討・事前準備をサポートします。
以下のルールに従ってください：
1. チェックリストに沿って一つずつ確認する
2. 関連する過去の事故・トラブル事例があれば必ず提示する
3. リスク評価を行い、注意すべき点を明確に伝える
4. 専門用語は正確に使うが、わかりやすく説明する
5. 不明な点があれば確認の質問をする

System Prompt（現場作業モード）:
あなたは建設・土木現場のベテラン技術者AIアシスタントです。
現場作業中のリアルタイムサポートを行います。
以下のルールに従ってください：
1. 簡潔かつ具体的にアドバイスする（音声で読み上げるため）
2. 安全に関わる事項は最優先で伝える
3. 過去の類似事故・事例があれば必ず警告する
4. 現場の状況に応じた判断を示す

参照ナレッジ:
{Azure Cognitive Searchから取得した関連ナレッジ}

参照事例:
{類似事例の検索結果}
```

---

## 6. セキュリティ設計

| 対策 | 実装 |
|------|------|
| 通信暗号化 | HTTPS（Azure App Service SSL） |
| 認証 | JWT（24h有効期限 + 7日リフレッシュトークン） |
| パスワード | bcryptjs によるハッシュ化 |
| セキュリティヘッダ | helmet.js（カスタムCSP設定） |
| レート制限 | express-rate-limit（本番: 1000req/15min、開発: 2000req/15min） |
| 入力バリデーション | express-validator |
| CORS | 許可オリジンのホワイトリスト（動的生成） |
| 機密情報 | 環境変数管理（Azure App Service設定） |
| データベース | PostgreSQL TDE + Azure暗号化 + SSL接続必須 |
| WebSocket認証 | Socket.IOハンドシェイクでJWTトークン検証 |

### CSPヘッダ設定

```javascript
contentSecurityPolicy: {
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"],
    styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
    fontSrc: ["'self'", "https://fonts.gstatic.com", "data:"],
    imgSrc: ["'self'", "data:", "blob:"],
    mediaSrc: ["'self'", "blob:"],
    connectSrc: ["'self'", "https://*.microsoft.com", "https://*.azure.com", "wss:", "ws:"],
    workerSrc: ["'self'", "blob:"],
  }
}
```

---

## 7. デプロイ構成

### 7.1 Dockerファイル構成

```dockerfile
# サーバー Dockerfile（マルチステージビルド）
FROM node:20-alpine AS frontend-build    # ① Reactビルド
FROM node:20-alpine AS production        # ② サーバー + ビルド済みクライアント

# 本番イメージ
WORKDIR /app
COPY server/package*.json ./
RUN npm ci --only=production
COPY server/ .
COPY --from=frontend-build /frontend/dist ./client/dist
EXPOSE 3001
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD node -e "http.get('http://127.0.0.1:3001/ping', ...)"
CMD ["sh", "-c", "npm run db:startup && npm start"]
```

### 7.2 Docker Compose（ローカル開発）

```yaml
services:
  postgres:     # PostgreSQL 14-alpine (port 5433)
  redis:        # Redis 7-alpine (port 6380)
  api:          # Node.js API (port 3010)
  client:       # Vite dev server (port 5174)
```

### 7.3 Azure本番構成

```
Azure Container Registry (knowhowacr.azurecr.io)
  └─ knowhow-api:latest / knowhow-api:tts-fix

Azure App Service
  └─ knowhow-api.azurewebsites.net（API + クライアント統合配信）

Azure Database for PostgreSQL Flexible Server
  └─ knowhow-db.postgres.database.azure.com

Azure Cache for Redis
  └─ knowhow-cache.redis.cache.windows.net:6380 (TLS)

Azure Cognitive Search
  └─ knowhow-search.search.windows.net (knowledge-index)

Azure OpenAI Service
  └─ eastus.api.cognitive.microsoft.com
     ├─ gpt-4o-mini deployment
     └─ text-embedding-ada-002 deployment

Azure Speech Services
  └─ japaneast (STT + TTS)
```

### 7.4 CI/CD パイプライン

```yaml
# .github/workflows/deploy-azure.yml
トリガー: main ブランチへの push（server/, client/, docker-compose.prod.yml, nginx.conf 変更時）

ジョブ:
  1. build-and-test: lint (server + client), build client
  2. build-docker: Docker イメージビルド → ACR プッシュ
  3. deploy-api: Azure App Service にデプロイ
  4. deploy-client: クライアント App Service にデプロイ
```

---

## 8. オフライン・PWA設計

### 8.1 Service Worker（Workbox）

- **プリキャッシュ**: HTML, CSS, JS, アイコン等の静的アセット
- **ランタイムキャッシュ**: `/api/knowledge` エンドポイント（StaleWhileRevalidate、最大100件、24時間）
- **自動更新**: 新バージョン検出時にユーザーへ通知

### 8.2 IndexedDB（オフラインDB）

| ストア | 用途 |
|--------|------|
| knowledge_cache | ナレッジデータのローカルキャッシュ |
| draft_messages | オフライン時の下書きメッセージキュー |
| metadata | 最終同期日時等のメタ情報 |

### 8.3 同期サービス

- オンライン復帰時に `draft_messages` の自動送信
- 送信成功後にローカル下書きを削除
