# ノウハウ共有AI音声アシスタント - 実装計画

**作成日**: 2026-02-11
**方針**: sales-app（営業日報アプリ）のコードベースを最大限流用し、開発速度を向上

---

## 0. 技術流用サマリー

### sales-appからコピー＆カスタマイズするもの

| コンポーネント | ファイル | カスタマイズ内容 |
|--------------|---------|----------------|
| JWT認証基盤 | server/src/middleware/auth.js | ロール名を変更（worker/expert/site_manager/admin） |
| 認証ルート | server/src/routes/auth.js | 登録時のフィールド追加（department, site_id） |
| DBプール設定 | server/src/db/pool.js | そのまま流用 |
| Redis設定 | server/src/services/redis.js | そのまま流用（フォールバック込み） |
| OpenAIサービス | server/src/services/openai.js | プロンプトをノウハウ用に変更 |
| 音声処理 | server/src/services/realtimeAI.js | 現場モード用にカスタマイズ |
| WebSocketハンドラ | server/src/websocket/realtimeHandler.js | ナレッジ検索連携を追加 |
| エラーハンドラ | server/src/middleware/errorHandler.js | そのまま流用 |
| Swagger設定 | server/src/config/swagger.js | エンドポイント定義を更新 |
| React基盤 | client/src/main.jsx, App.jsx | ルーティング変更 |
| 認証コンテキスト | client/src/contexts/AuthContext.jsx | そのまま流用 |
| デザインシステム | client/src/styles/ | 配色をカスタマイズ |
| 音声入力コンポーネント | client/src/components/SimpleVoiceInput.jsx | そのまま流用 |
| レイアウト | client/src/components/Layout.jsx | ナビゲーション変更 |
| Docker設定 | Dockerfile, docker-compose.yml | サービス名・ポート変更 |
| CI/CD | .github/workflows/deploy-azure.yml | リソース名変更 |
| Nginx設定 | nginx.conf | そのまま流用 |
| Vite設定 | client/vite.config.js | そのまま流用 |
| PWA設定 | Workbox設定 | キャッシュ戦略をナレッジ向けに調整 |

---

## Phase 1: プロジェクト基盤構築（5日間）

### 1.1 プロジェクト初期化（1日目）

- [ ] sales-appからプロジェクト構造をコピー
  ```
  knowhow/
  ├── client/          # sales-app/client をベースに
  ├── server/          # sales-app/server をベースに
  ├── docker-compose.yml
  ├── .github/workflows/
  └── docs/
  ```
- [ ] package.jsonの依存関係を整理（不要なCRM関連を除去、Azure Search追加）
- [ ] 環境変数テンプレート作成（.env.example）
- [ ] CLAUDE.md をknowhowプロジェクト用に作成

### 1.2 Azure環境セットアップ（2日目）

- [ ] Azure Resource Groupの作成（knowhow-rg）
- [ ] Azure Database for PostgreSQL Flexibleのプロビジョニング
- [ ] Azure Cache for Redisのプロビジョニング
- [ ] Azure OpenAI Serviceの設定
  - [ ] GPT-4 deploymentの作成
  - [ ] text-embedding-ada-002 deploymentの作成（**新規**）
- [ ] Azure Speech Servicesの設定
- [ ] Azure Cognitive Searchの作成（**新規**）
  - [ ] knowledge-indexの作成
  - [ ] incident-indexの作成
- [ ] Azure App Serviceの作成
- [ ] Azure Container Registryの設定

### 1.3 データベース構築（3日目）

- [ ] スキーマ作成（server/src/db/schema.sql）
  - users, sites, knowledge_items, incident_cases, checklists, checklist_items, voice_sessions, voice_session_messages, usage_logs, knowledge_tags
- [ ] マイグレーション機構のセットアップ（sales-appのmigrate.jsを流用）
- [ ] 初期シードデータの作成
  - [ ] テストユーザー（各ロール）
  - [ ] サンプル現場データ
  - [ ] サンプルナレッジ（5〜10件）
  - [ ] サンプル事例（3〜5件）

### 1.4 認証機能（4日目）

- [ ] 認証ミドルウェアのカスタマイズ（sales-app/server/src/middleware/auth.jsベース）
  - ロール: worker, expert, site_manager, admin
- [ ] 認証ルートのカスタマイズ（sales-app/server/src/routes/auth.jsベース）
  - 登録時に department, site_id を追加
- [ ] ログイン画面のカスタマイズ（sales-app/client/src/pages/LoginPage.jsxベース）
- [ ] 登録画面のカスタマイズ

### 1.5 基本UI/UXフレームワーク（5日目）

- [ ] デザインシステムのカスタマイズ（配色を建設業向けに）
- [ ] Layout.jsxのカスタマイズ（ナビゲーション変更）
- [ ] ホーム画面の実装
  - モード選択ボタン（事務作業 / 現場作業）
  - 最近のナレッジ表示
  - オフライン状態表示

**Phase 1 成果物**: 認証付きの基本UIが動作する状態

---

## Phase 2: ナレッジ管理コア機能（7日間）

### 2.1 ナレッジCRUD API（6〜7日目）

- [ ] ナレッジルート実装（/api/knowledge）
  - GET（一覧、フィルタ対応）、POST、PUT、DELETE
- [ ] ナレッジ詳細取得（関連ナレッジ含む）
- [ ] 承認ワークフロー（draft → review → published）
- [ ] タグ自動付与（sales-appのtagExtractor.jsベース）

### 2.2 ベクトル検索機能（8〜9日目）

- [ ] Azure OpenAI Embeddings統合
  - ナレッジ登録時にembedding生成
  - text-embedding-ada-002による1536次元ベクトル
- [ ] Azure Cognitive Searchインデックス管理
  - ドキュメントの追加/更新/削除
- [ ] セマンティック検索API実装
  - 自然言語クエリ → embedding生成 → ベクトル検索
  - ハイブリッド検索（キーワード + ベクトル）

### 2.3 事例管理機能（10日目）

- [ ] 事例CRUD API実装（/api/incidents）
- [ ] 事例のベクトル化・インデックス登録
- [ ] 類似事例検索API

### 2.4 チェックリスト機能（11日目）

- [ ] チェックリストCRUD API
- [ ] チェック実行機能（結果記録）
- [ ] ナレッジとの関連付け

### 2.5 ナレッジ管理UI（12日目）

- [ ] ナレッジ一覧画面（検索・フィルタ付き）
- [ ] ナレッジ詳細画面（関連事例・チェックリスト表示）
- [ ] ナレッジ登録画面（テキスト入力）
- [ ] ナレッジ検索画面（キーワード・フィルタ）

**Phase 2 成果物**: ナレッジの登録・検索・管理が動作する状態

---

## Phase 3: AI対話エンジン（7日間）

### 3.1 事務作業モード - AIチャットボット（13〜15日目）

- [ ] AI対話サービスの実装（sales-appのopenai.jsベース）
  - 建設・土木向けのSystem Prompt設計
  - ナレッジDB連携（検索結果をコンテキストに注入）
  - チェックリスト連動フロー
- [ ] チャットUI実装（sales-appのHearingPage.jsxベース）
  - メッセージ表示エリア
  - テキスト入力
  - チェック進捗インジケーター
- [ ] 類災事例の自動提示機能
- [ ] リスク評価アシスト機能

### 3.2 現場作業モード - 音声アシスタント（16〜18日目）

- [ ] 音声入力統合（sales-appのSimpleVoiceInput.jsxベース）
  - Web Speech API（短時間向け）
  - Azure Speech SDK（高精度向け）
- [ ] 音声出力統合（Azure TTS / Nanami Neural Voice）
- [ ] WebSocketリアルタイム通信（sales-appのSocket.IO構成を流用）
  - 音声ストリーミング
  - リアルタイムAI応答
- [ ] 現場作業モードUI
  - 大きなマイクボタン
  - 音声波形表示
  - ハンズフリー操作対応
  - 高コントラスト表示

### 3.3 セッション管理（19日目）

- [ ] 音声セッションの作成・管理
- [ ] セッション履歴の保存
- [ ] セッション内のナレッジ参照ログ記録

**Phase 3 成果物**: 事務作業モード（チャット）と現場作業モード（音声）が動作する状態

---

## Phase 4: 分析・管理機能（5日間）

### 4.1 分析ダッシュボード（20〜21日目）

- [ ] ナレッジ活用状況API
  - 閲覧数、検索回数、「役に立った」数の集計
- [ ] ユーザー別学習進捗API
- [ ] ダッシュボードUI（sales-appのAnalyticsPage.jsxベース）
  - Rechartsによるグラフ表示

### 4.2 リスク分析機能（22日目）

- [ ] リスク傾向分析API（現場別・工種別）
- [ ] ナレッジギャップ分析（カバーされていない領域の特定）
- [ ] 分析結果の表示UI

### 4.3 管理機能（23〜24日目）

- [ ] 現場管理機能（CRUD）
- [ ] ユーザー管理機能（ロール変更、所属変更）
- [ ] ナレッジ承認画面（管理者用）
- [ ] 利用統計レポート

**Phase 4 成果物**: 分析ダッシュボードと管理機能が動作する状態

---

## Phase 5: オフライン・PWA対応（3日間）

### 5.1 PWA設定（25日目）

- [ ] Service Worker設定（sales-appのWorkbox設定ベース）
- [ ] マニフェスト作成
- [ ] アイコン・スプラッシュ画面

### 5.2 オフライン対応（26日目）

- [ ] IndexedDBによるナレッジキャッシュ
  - 頻繁にアクセスするナレッジの自動キャッシュ
  - 現場ごとの関連ナレッジの事前ダウンロード
- [ ] オフライン時のUI対応
  - キャッシュ済みナレッジの閲覧
  - テキスト入力・下書き保存
  - オンライン復帰時の自動同期

### 5.3 プッシュ通知基盤（27日目）

- [ ] ブラウザ通知API対応
- [ ] 通知設定画面
- [ ] （将来対応: Azure Notification Hubs連携）

**Phase 5 成果物**: オフラインでもナレッジ閲覧可能なPWA

---

## Phase 6: 品質向上・デプロイ（5日間）

### 6.1 テスト（28〜29日目）

- [ ] API単体テスト（主要エンドポイント）
- [ ] 認証・認可テスト
- [ ] 音声認識の動作テスト（ブラウザ別）
- [ ] ベクトル検索の精度テスト
- [ ] オフライン動作テスト

### 6.2 パフォーマンス最適化（30日目）

- [ ] API応答速度の計測・最適化
- [ ] 音声認識レイテンシの最適化
- [ ] ベクトル検索のインデックス最適化
- [ ] フロントエンドバンドルサイズ最適化

### 6.3 セキュリティ監査（31日目）

- [ ] OWASP Top 10チェック
- [ ] 認証フローの検証
- [ ] データアクセス権限の検証
- [ ] 環境変数・シークレット管理の確認

### 6.4 デプロイ・ドキュメント（32日目）

- [ ] GitHub Actions CI/CDパイプライン設定
- [ ] Azure環境への本番デプロイ
- [ ] 運用手順書の作成
- [ ] API仕様書（Swagger）の最終確認

**Phase 6 成果物**: 本番環境にデプロイされた完成システム

---

## スケジュールサマリー

| Phase | 期間 | 内容 | 日数 |
|-------|------|------|------|
| Phase 1 | Week 1 | プロジェクト基盤構築 | 5日 |
| Phase 2 | Week 2 | ナレッジ管理コア機能 | 7日 |
| Phase 3 | Week 3 | AI対話エンジン | 7日 |
| Phase 4 | Week 4 | 分析・管理機能 | 5日 |
| Phase 5 | Week 4-5 | オフライン・PWA対応 | 3日 |
| Phase 6 | Week 5 | 品質向上・デプロイ | 5日 |
| **合計** | | | **約32日（6.5週間）** |

---

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 建設現場の騒音で音声認識精度が低下 | ユーザー体験の低下 | Azure Speech SDKのノイズ抑制 + テキスト入力フォールバック |
| ベクトル検索の精度不足 | 関連ナレッジが正しく取得できない | ハイブリッド検索（キーワード+ベクトル）の採用、プロンプトチューニング |
| ナレッジ初期データ不足 | AIの応答品質が低い | デモ用サンプルデータの充実、段階的なデータ蓄積計画 |
| Azure Cognitive Searchのコスト | 予算超過 | Freeティア（50MB）で開始、必要に応じてスケールアップ |
| オフライン時の機能制限 | 現場での利用が制限される | 重要ナレッジの事前キャッシュ戦略 |

---

## 将来の拡張予定

- [ ] ドキュメント自動取り込み（PDF/Word → ナレッジ化）
- [ ] 画像認識によるナレッジ検索（現場写真から関連ナレッジを検索）
- [ ] AR連携（現場でのナレッジオーバーレイ表示）
- [ ] 多言語対応（外国人技術者向け）
- [ ] SAPなど既存業務システムとの連携
- [ ] プッシュ型ナレッジ提案の高度化（作業計画書解析による自動推薦）
