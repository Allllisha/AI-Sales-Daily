# ノウハウ共有AI音声アシスタント - 実装状況

**作成日**: 2026-02-11
**最終更新**: 2026-02-12
**ステータス**: 本番稼働中（Azure App Service）

---

## 0. プロジェクト構成

```
knowhow/
├── client/                 # React 18 フロントエンド (Vite + PWA)
│   ├── src/
│   │   ├── components/     # 再利用可能コンポーネント（17個）
│   │   ├── contexts/       # AuthContext, useOnlineStatus
│   │   ├── pages/          # ページコンポーネント（25画面）
│   │   ├── services/       # api.js, offlineDB.js, syncService.js
│   │   ├── styles/         # Emotionベースのスタイル定義
│   │   ├── App.jsx         # ルーティング定義
│   │   └── main.jsx        # エントリポイント
│   ├── public/             # PWAマニフェスト、アイコン
│   ├── package.json
│   ├── vite.config.js      # Vite + PWA設定
│   └── Dockerfile
├── server/                 # Node.js Express バックエンド
│   ├── src/
│   │   ├── config/         # swagger.js
│   │   ├── db/             # pool.js, schema.sql, migrate.js, seed.js, startup.js
│   │   ├── middleware/     # auth.js, errorHandler.js
│   │   ├── routes/         # 9つのルートファイル
│   │   ├── services/       # openai.js, redis.js, searchService.js, embeddingService.js, tagExtractor.js, realtimeAI.js
│   │   ├── websocket/      # realtimeHandler.js
│   │   └── index.js        # サーバーエントリポイント
│   ├── package.json
│   └── Dockerfile
├── docs/                   # ドキュメント
├── .github/workflows/      # CI/CD パイプライン
├── docker-compose.yml      # ローカル開発環境
├── docker-compose.prod.yml # 本番構成
└── nginx.conf              # Nginx設定（クライアント用）
```

---

## Phase 1: プロジェクト基盤構築 -- 完了

### 1.1 プロジェクト初期化

- [x] プロジェクト構造の作成（client/ + server/）
- [x] package.json の依存関係整理
- [x] 環境変数テンプレート作成（.env.example）
- [x] CLAUDE.md 作成

### 1.2 Azure環境セットアップ

- [x] Azure Resource Group 作成（knowhow-rg）
- [x] Azure Database for PostgreSQL Flexible（knowhow-db）
- [x] Azure Cache for Redis（knowhow-cache、TLS port 6380）
- [x] Azure OpenAI Service（eastus）
  - [x] gpt-4o-mini deployment
  - [x] text-embedding-ada-002 deployment
- [x] Azure Speech Services（japaneast）
- [x] Azure Cognitive Search（knowhow-search）
  - [x] knowledge-index 作成
- [x] Azure App Service（knowhow-api）
- [x] Azure Container Registry（knowhowacr）

### 1.3 データベース構築

- [x] スキーマ作成（12テーブル: users, sites, knowledge_items, knowledge_tags, incident_cases, checklists, checklist_items, checklist_executions, checklist_execution_items, voice_sessions, voice_session_messages, usage_logs）
- [x] マイグレーション機構（migrate.js + startup.js）
- [x] 初期シードデータ
  - [x] テストユーザー（6名: admin, site_manager×2, expert, worker×2）
  - [x] サンプル現場（3現場: 東京湾岸橋梁、名古屋高速道路、大阪港湾施設）
  - [x] サンプルナレッジ（15件: 橋梁補修中心）
  - [x] サンプル事例（8件: 類災事例）
  - [x] サンプルチェックリスト（4件: 作業前点検）
  - [x] 音声セッション（3件）+ メッセージ
  - [x] チェックリスト実行記録（2件）
  - [x] 利用ログ（15件）

### 1.4 認証機能

- [x] JWT認証ミドルウェア（authMiddleware）
- [x] ロールベースアクセス制御（adminOnly, managerOrAdmin, expertOrAbove）
- [x] 認証ルート（register, login, logout, refresh, me, reset-password）
- [x] ログイン画面（LoginPage.jsx）
- [x] ユーザー登録画面（RegisterPage.jsx）
- [x] 30分無操作時の自動ログアウト

### 1.5 基本UI/UXフレームワーク

- [x] Emotion CSS-in-JS によるデザインシステム
- [x] Layout.jsx（サイドバーナビゲーション、モバイルレスポンシブ）
- [x] ホーム画面（モード選択、クイックアクセス）
- [x] PrivateRoute（認証ガード）
- [x] オンライン/オフライン状態検出（useOnlineStatus）

---

## Phase 2: ナレッジ管理コア機能 -- 完了

### 2.1 ナレッジCRUD API

- [x] /api/knowledge ルート（GET, POST, PUT, DELETE）
- [x] カテゴリ・工種・状態・リスクレベルフィルタ
- [x] ナレッジ詳細取得（閲覧数自動カウント）
- [x] 承認ワークフロー（draft → review → published → archived）
- [x] AIタグ自動付与（tagExtractor.js）

### 2.2 ベクトル検索機能

- [x] Azure OpenAI Embeddings統合（text-embedding-ada-002、1536次元）
- [x] Azure Cognitive Search インデックス管理（searchService.js）
- [x] セマンティック検索API（POST /api/knowledge/search）
- [x] ハイブリッド検索（キーワード + ベクトル）

### 2.3 事例管理機能

- [x] /api/incidents ルート（GET, POST, PUT）
- [x] 事例のベクトル化・インデックス登録
- [x] 類似事例検索API（POST /api/incidents/search）

### 2.4 チェックリスト機能

- [x] /api/checklists ルート（GET, POST, PUT）
- [x] チェック実行機能（POST /:id/execute）
- [x] 実行結果記録・履歴閲覧
- [x] ナレッジとの関連付け

### 2.5 ナレッジ管理UI

- [x] ナレッジ一覧画面（KnowledgeListPage.jsx）-- カテゴリ・工種・状態フィルタ
- [x] ナレッジ詳細画面（KnowledgeDetailPage.jsx）-- 関連事例表示、編集、「役に立った」
- [x] ナレッジ作成画面（KnowledgeCreatePage.jsx）-- フォームバリデーション付き
- [x] ナレッジ検索画面（KnowledgeSearchPage.jsx）-- セマンティック検索
- [x] 事例一覧・作成・詳細画面（IncidentListPage, IncidentCreatePage, IncidentDetailPage）
- [x] チェックリスト一覧・作成・詳細画面（ChecklistListPage, ChecklistCreatePage, ChecklistDetailPage）
- [x] CSVエクスポート機能

---

## Phase 3: AI対話エンジン -- 完了

### 3.1 事務作業モード - AIチャットボット

- [x] AI対話サービス（openai.js -- Azure OpenAI GPT-4o-mini）
  - [x] 建設・土木向けSystem Prompt
  - [x] ナレッジDB連携（検索結果をコンテキストに注入）
  - [x] チェックリスト連動フロー
- [x] OfficeChatPage.jsx
  - [x] メッセージ表示エリア（Markdown対応）
  - [x] テキスト入力
  - [x] サイドバー会話履歴
  - [x] オフライン下書き保存（IndexedDB）
- [x] 類災事例の自動提示機能
- [x] リスク評価アシスト（RiskAssessmentPage.jsx）
- [x] 安全ハブ画面（SafetyHubPage.jsx）

### 3.2 現場作業モード - 音声アシスタント

- [x] 音声入力（Web Speech API -- ja-JP、30秒タイムアウト）
- [x] 音声出力（Azure Speech TTS -- Nanami Neural Voice）
  - [x] Web Audio API による再生（AudioContext.decodeAudioData）
  - [x] CSP対応（blob: URL不使用）
  - [x] ブラウザ内蔵TTS フォールバック（SpeechSynthesis API）
- [x] VADエコーキャンセル（TTS再生中のマイク入力抑制）
- [x] FieldVoicePage.jsx
  - [x] 大きなマイクボタン（タップで録音開始/停止）
  - [x] 音声波形表示
  - [x] 関連ナレッジのリアルタイム推薦
  - [x] 高コントラスト表示
- [x] WebSocketリアルタイム通信（Socket.IO + realtimeHandler.js）

### 3.3 セッション管理

- [x] 音声セッションのCRUD（/api/ai/voice-sessions）
- [x] セッション履歴画面（SessionHistoryPage.jsx）
- [x] セッション詳細画面（SessionDetailPage.jsx）-- トランスクリプト表示
- [x] セッション完了機能

---

## Phase 4: 分析・管理機能 -- 完了

### 4.1 分析ダッシュボード

- [x] ナレッジ活用状況API（/api/analytics/usage）
- [x] ユーザー別学習進捗API（/api/analytics/users/:id）
- [x] AnalyticsDashboardPage.jsx（チーム活動、利用メトリクス）
- [x] UserAnalyticsPage.jsx（個人別統計、パフォーマンス）
- [x] Rechartsによるグラフ表示

### 4.2 リスク分析機能

- [x] リスク傾向分析API（/api/analytics/risks）-- 現場別・工種別
- [x] ナレッジギャップ分析API（/api/analytics/knowledge-gaps）

### 4.3 管理機能

- [x] 現場管理（SiteListPage, SiteCreatePage, SiteDetailPage）
- [x] ユーザー管理API（/api/users -- 一覧、ロール変更、チーム管理）
- [x] 分析データエクスポート（CSV, PDF）

---

## Phase 5: オフライン・PWA対応 -- 完了

### 5.1 PWA設定

- [x] Vite PWA Plugin 設定（generateSW モード）
- [x] Service Worker 自動登録（Workbox）
- [x] マニフェスト作成（manifest.webmanifest）
- [x] アプリアイコン（knowhow-icon.svg）

### 5.2 オフライン対応

- [x] IndexedDB（offlineDB.js）
  - [x] knowledge_cache ストア（ナレッジキャッシュ）
  - [x] draft_messages ストア（下書きメッセージ）
  - [x] metadata ストア（同期情報）
- [x] ランタイムキャッシュ（/api/knowledge -- StaleWhileRevalidate、100件、24時間）
- [x] 同期サービス（syncService.js -- オンライン復帰時に下書き自動送信）
- [x] オフライン状態表示（useOnlineStatus フック）

---

## Phase 6: 品質向上・デプロイ -- 完了

### 6.1 セキュリティ

- [x] helmet.js カスタムCSP設定
  - [x] Google Fonts 許可（styleSrc, fontSrc）
  - [x] blob: URL 許可（mediaSrc, imgSrc, workerSrc）
  - [x] WebSocket 許可（connectSrc: wss:, ws:）
- [x] CORS ホワイトリスト（本番・開発別設定）
- [x] レート制限（express-rate-limit）
- [x] 入力バリデーション（express-validator）

### 6.2 Docker・デプロイ

- [x] マルチステージ Dockerfile（frontend-build → production）
- [x] docker-compose.yml（ローカル開発: postgres, redis, api, client）
- [x] docker-compose.prod.yml（本番構成）
- [x] GitHub Actions CI/CD パイプライン
  - [x] build-and-test（lint + build）
  - [x] build-docker（ACR push）
  - [x] deploy-api / deploy-client
- [x] Azure App Service デプロイ完了
- [x] ヘルスチェック（/health, /ping）

### 6.3 API仕様書

- [x] Swagger UI（/api-docs）

---

## 実装済み機能サマリー

| カテゴリ | 機能数 | 状態 |
|---------|--------|------|
| 認証・ユーザー管理 | 6 API + 2画面 | 完了 |
| ナレッジ管理 | 10 API + 4画面 | 完了 |
| 事例管理 | 5 API + 3画面 | 完了 |
| チェックリスト | 7 API + 3画面 | 完了 |
| AI対話（事務作業） | 6 API + 1画面 | 完了 |
| AI対話（現場音声） | 6 API + 1画面 | 完了 |
| 音声処理（STT/TTS） | 2 API + WebSocket | 完了 |
| 分析・レポート | 6 API + 2画面 | 完了 |
| 現場管理 | 4 API + 3画面 | 完了 |
| ユーザー管理 | 6 API | 完了 |
| オフライン・PWA | Service Worker + IndexedDB | 完了 |
| セキュリティ | JWT + helmet + CORS + Rate Limit | 完了 |
| **合計** | **約60 API + 25画面** | **全完了** |

---

## 本番環境情報

| 項目 | 値 |
|------|-----|
| API URL | https://knowhow-api.azurewebsites.net |
| API Docs | https://knowhow-api.azurewebsites.net/api-docs |
| Health Check | https://knowhow-api.azurewebsites.net/health |
| ACR | knowhowacr.azurecr.io |
| DB | knowhow-db.postgres.database.azure.com |
| Redis | knowhow-cache.redis.cache.windows.net:6380 |

---

## テストユーザー（シードデータ）

| メール | パスワード | ロール | 名前 |
|--------|-----------|--------|------|
| admin@example.com | password123 | admin | 管理者太郎 |
| manager1@example.com | password123 | site_manager | 鈴木現場長 |
| manager2@example.com | password123 | site_manager | 高橋監督 |
| expert@example.com | password123 | expert | 佐藤熟練者 |
| worker1@example.com | password123 | worker | 田中作業員 |
| worker2@example.com | password123 | worker | 山田新人 |

---

## 将来の拡張予定

- [ ] ドキュメント自動取り込み（PDF/Word → ナレッジ化）
- [ ] 画像認識によるナレッジ検索（現場写真から関連ナレッジを検索）
- [ ] AR連携（現場でのナレッジオーバーレイ表示）
- [ ] 多言語対応（外国人技術者向け）
- [ ] Salesforce / SAP等の既存業務システムとの連携
- [ ] Azure Notification Hubsによるプッシュ通知
- [ ] 高度な分析機能（予測分析、AIコーチング）
- [ ] 議事録からの自動ナレッジ抽出
